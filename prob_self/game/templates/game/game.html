{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <meta charset="UTF-8">
    <title>Game Page</title>
</head>
<body>

<div id="container"></div>
<script src="{% static 'js/Environment.js' %}">

var game = new Game("logic");

var markup = board.map(row => row.map(col => `<span class="field ${col === 8 ? "avatar" : col === 3 ? "goal" : col === 0 ? "grass" : "wall" }"></span>` ).join("")).join("<span class='clear'></span>");
document.getElementById("container").innerHTML = markup;

function paintBoard() {
    console.log("painting");
    console.log(board);
    markup = board.map(row => row.map(col => `<span class="field ${col === 8 ? "avatar" : col === 3 ? "goal" : col === 0 ? "grass" : "wall" }"></span>` ).join("")).join("<span class='clear'></span>");
    document.getElementById("container").innerHTML = markup;
}

function nextLevel() {
    var rn = rand(9);
    board = JSON.parse(JSON.stringify(levels[rn])); // Deep Copy
    random_avatar_pos();
    level_count++;

    if(level_count == 5) {
        alert("Game Won!");
    }
}



/*
*
* up = 0
* down = 1
* left = 2
* right = 3
*
*/
function move(direction, board, avatarPos) {
    let x = avatarPos[0]
    let y = avatarPos[1]
    let new_x = x;
    let new_y = y;
    switch (direction) {
        case 0:
            new_x--;
            break;
        case 1:
            new_x++;
            break;
        case 2:
            new_y--;
            break;
        case 3:
            new_y++;
            break;
    }

    if( canMove(direction, board, avatarPosition) === 1 ) {
        board[x][y] = 0; // set avatar's old position to grass
        board[new_x][new_y] = 8;
        avatarPosition = [new_x, new_y];
    } else if( canMove(direction, board, avatarPosition) === 2 ) {
        nextLevel();
    }  else {
        console.log("cannot move");
    }

    paintBoard();
}

// returns 0 if the avatar cannot move to the specified location, 1 if avatar can move and 2 if avatar reaches goal
function canMove(direction, board, avatarPos) {
    let x = avatarPos[0];
    let y = avatarPos[1];
    var next = 0;
    switch (direction) {
        case 0: // up
            next = board[x - 1][y];
            break;
        case 1: // down
            next = board[x + 1][y];
            break;
        case 2: // left
            next = board[x][y - 1];
            break;
        case 3: // right
            next = board[x][y + 1];
            break;
    }

    if( next === 1 || next === 8 ) { // There is a wall or another non-agent, cannot move
        return 0;
    } else if( next === 0 ) { // There is grass, can move
        return 1;
    } else if( next === 3 ) { // Reached Goal!
        return 2;
    }
}

$(document).ready(function(){
    document.addEventListener("keydown", keyHandler, false);
    function keyHandler(event) {
        if (document.readyState == 'complete'&& // listen only if document is loaded
            (event.key === 'w' || event.key === 'a' || event.key === 's' || event.key === 'd'
                || event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'ArrowLeft' ||
                event.key === 'ArrowRight')) { // move
            let tmp;
            switch (event.key) {
                case "w":
                    tmp = 0;
                    break;
                case "s":
                    tmp = 1;
                    break;
                case "a":
                    tmp = 2;
                    break;
                case "d":
                    tmp = 3;
                    break;
                case "ArrowUp":
                    tmp = 0;
                    break;
                case "ArrowDown":
                    tmp = 1;
                    break;
                case "ArrowLeft":
                    tmp = 2;
                    break;
                case "ArrowRight":
                    tmp = 3;
                    break;
            }

            move( tmp, board, avatarPosition );
            console.log("avatar pos: " + avatarPosition );
}}});

</script>


<style>

    .field {
      float: left;
      height: 50px;
      width: 50px;
      border: 1px solid #000;
    }

    .clear {
      clear: both;
      float: left;
    }

    .grass {
      background: gray;
    }

    .wall {
      background: black;
    }

    .avatar {
      background: red;
    }

    .goal {
      background: green;
    }

</style>

</body>
</html>